<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <header class="bg-primary text-white text-center py-4">
        <h1>Camera</h1>
    </header>

    <main class="container mt-4">
        <div class="container">
            <section>
              Real time:<br>
              <video id="realtime" autoplay muted controls></video>
            </section>
            <section>
              Delayed:<br>
              <video id="delayed" autoplay muted controls></video>
            </section>
            <div class="slidecontainer">
                <input type="range" min="1" max="10" value="7" class="slider" id="myRange">
              </div>
              <div id="demo"></div>
        </div>
    </main>

    <footer class="bg-dark text-white text-center py-3 mt-4">
        <p>&copy; 2024 Your Name. All rights reserved.</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
document.body.classList.add("overlay");
var slider = document.getElementById("myRange");
var output = document.getElementById("demo");
output.innerHTML = slider.value; // Display the default slider value
// Update the current slider value (each time you drag the slider handle)
slider.oninput = function() {
  output.innerHTML = this.value;
}

onclick = async () => {
	document.body.classList.remove("overlay");
  const delay = slider.value * 1000;
  const mimeType = `video/webm; codecs="vp8"`;
  const stream = await getStream();
  document.getElementById("realtime").srcObject = stream;
  const mediaSource = new MediaSource();
  const delayed = document.getElementById("delayed");
  delayed.src = URL.createObjectURL(mediaSource);
  await new Promise((res) =>
    mediaSource.addEventListener("sourceopen", res, { once: true })
  );
  const sourceBuffer = mediaSource.addSourceBuffer(mimeType);
  const recorder = new MediaRecorder(stream, { mimeType });
  const chunks = [];
  recorder.ondataavailable = async ({ data }) => {
    if (mediaSource.readyState !== "open" || !data.size) {
      return;
    }
    sourceBuffer.appendBuffer(await data.arrayBuffer());
  };
  delayed.pause();
  recorder.start(50);
  setTimeout(() => delayed.play(), delay);
}

function getStream() {
  return navigator.mediaDevices.getUserMedia({ video: true });
}
</script>

</body>

</html>
